/*******************************************************************************
	GLUE-Math Library: log-factorial

	Author: Hironobu Inatsuka aka tribusonz
	License: GPL + X11(MIT)
	Reference:
		John D. Cook Consulting
*******************************************************************************/
#ifndef GML_LOGFACTRIAL_DBL_INTERNAL
#define GML_LOGFACTRIAL_DBL_INTERNAL

#if defined(__cplusplus)
extern "C" {
#endif

// uses math library: log()
#include "../../sys/float/huge_val_nan.h"
#include "log.h"

static inline double
logfactorial_core(register int n)
{
	static const double PI = 3.141592653589793238462643383;
	// for IEEE-754 FP double precision
	static const double lf[] =
	{
		0.0,
		0.0,
		0.693147180559945e0,
		0.1791759469228055e1,
		0.3178053830347946e1,
		0.4787491742782046e1,
		0.6579251212010101e1,
		0.8525161361065414e1,
		0.1060460290274525e2,
		0.1280182748008147e2,
		0.15104412573075515e2,
		0.17502307845873886e2,
		0.19987214495661886e2,
		0.22552163853123423e2,
		0.25191221182738682e2,
		0.27899271383840892e2,
		0.30671860106080673e2,
		0.33505073450136889e2,
		0.36395445208033054e2,
		0.39339884187199494e2,
		0.42335616460753485e2,
		0.45380138898476908e2,
		0.48471181351835224e2,
		0.51606675567764374e2,
		0.54784729398112319e2,
		0.5800360522298052e2,
		0.61261701761002002e2,
		0.64557538627006331e2,
		0.67889743137181535e2,
		0.71257038967168009e2,
		0.74658236348830164e2,
		0.78092223553315311e2,
		0.81557959456115037e2,
		0.85054467017581517e2,
		0.88580827542197679e2,
		0.92136175603687092e2,
		0.95719694542143202e2,
		0.99330612454787427e2,
		0.102968198614513813e3,
		0.106631760260643459e3,
		0.110320639714757395e3,
		0.114034211781461703e3,
		0.117771881399745072e3,
		0.121533081515438634e3,
		0.125317271149356895e3,
		0.129123933639127215e3,
		0.13295257503561631e3,
		0.136802722637326368e3,
		0.140673923648234259e3,
		0.144565743946344886e3,
		0.148477766951773032e3,
		0.152409592584497358e3,
		0.156360836303078785e3,
		0.160331128216630907e3,
		0.164320112263195181e3,
		0.168327445448427652e3,
		0.172352797139162802e3,
		0.176395848406997352e3,
		0.180456291417543771e3,
		0.184533828861449491e3,
		0.188628173423671591e3,
		0.192739047287844902e3,
		0.196866181672889994e3,
		0.201009316399281527e3,
		0.205168199482641199e3,
		0.209342586752536836e3,
		0.213532241494563261e3,
		0.217736934113954227e3,
		0.221956441819130334e3,
		0.226190548323727593e3,
		0.230439043565776952e3,
		0.234701723442818268e3,
		0.238978389561834323e3,
		0.243268849002982714e3,
		0.247572914096186884e3,
		0.251890402209723194e3,
		0.256221135550009525e3,
		0.260564940971863209e3,
		0.264921649798552801e3,
		0.269291097651019823e3,
		0.273673124285693704e3,
		0.278067573440366143e3,
		0.282474292687630396e3,
		0.286893133295426994e3,
		0.291323950094270308e3,
		0.295766601350760624e3,
		0.300220948647014132e3,
		0.304686856765668715e3,
		0.309164193580146922e3,
		0.313652829949879062e3,
		0.318152639620209327e3,
		0.322663499126726177e3,
		0.327185287703775217e3,
		0.331717887196928473e3,
		0.336261181979198477e3,
		0.340815058870799018e3,
		0.345379407062266854e3,
		0.349954118040770237e3,
		0.354539085519440809e3,
		0.359134205369575399e3,
		0.36373937555556349e3,
		0.36835449607240475e3,
		0.372979468885689021e3,
		0.377614197873918656e3,
		0.382258588773060029e3,
		0.386912549123217552e3,
		0.39157598821732962e3,
		0.396248817051791526e3,
		0.400930948278915745e3,
		0.405622296161144889e3,
		0.410322776526937305e3,
		0.41503230672824964e3,
		0.419750805599544734e3,
		0.424478193418257075e3,
		0.42921439186665157e3,
		0.43395932399501482e3,
		0.438712914186121185e3,
		0.443475088120918941e3,
		0.448245772745384606e3,
		0.453024896238496135e3,
		0.457812387981278181e3,
		0.462608178526874922e3,
		0.467412199571608179e3,
		0.472224383926980596e3,
		0.477044665492585633e3,
		0.481872979229887934e3,
		0.486709261136839412e3,
		0.491553448223298003e3,
		0.496405478487217621e3,
		0.501265290891579293e3,
		0.506132825342034875e3,
		0.511008022665236027e3,
		0.515890824587822398e3,
		0.520781173716044151e3,
		0.525679013515995063e3,
		0.530584288294433492e3,
		0.535496943180169544e3,
		0.540416924105997669e3,
		0.545344177791154874e3,
		0.550278651724285566e3,
		0.55522029414689487e3,
		0.560169054037273038e3,
		0.565124881094874299e3,
		0.570087725725134206e3,
		0.575057539024710207e3,
		0.580034272767130781e3,
		0.585017879388839118e3,
		0.590008311975617854e3,
		0.595005524249381969e3,
		0.600009470555327428e3,
		0.605020105849423684e3,
		0.610037385686238608e3,
		0.615061266207084885e3,
		0.62009170412847732e3,
		0.625128656730890949e3,
		0.630172081847810196e3,
		0.635221937855059733e3,
		0.640278183660408041e3,
		0.645340778693435008e3,
		0.650409682895655239e3,
		0.655484856710889066e3,
		0.660566261075873529e3,
		0.665653857411105913e3,
		0.670747607611912676e3,
		0.675847474039736874e3,
		0.680953419513637455e3,
		0.686065407301993998e3,
		0.691183401114410753e3,
		0.696307365093814012e3,
		0.701437263808737085e3,
		0.706573062245787347e3,
		0.711714725802290007e3,
		0.71686222027910346e3,
		0.722015511873601239e3,
		0.727174567172815768e3,
		0.732339353146739282e3,
		0.737509837141777434e3,
		0.742685986874351263e3,
		0.747867770424643348e3,
		0.753055156230484103e3,
		0.758248113081374313e3,
		0.763446610112640139e3,
		0.768650616799716935e3,
		0.773860102952558356e3,
		0.779075038710167341e3,
		0.784295394535245666e3,
		0.789521141208958867e3,
		0.794752249825813454e3,
		0.799988691788643403e3,
		0.805230438803703045e3,
		0.810477462875863532e3,
		0.815729736303910161e3,
		0.820987231675937943e3,
		0.826249921864842829e3,
		0.831517780023906157e3,
		0.836790779582469903e3,
		0.842068894241700421e3,
		0.847352097970438409e3,
		0.852640365001132944e3,
		0.857933669825857437e3,
		0.863231987192405473e3,
		0.868535292100464549e3,
		0.873843559797865754e3,
		0.879156765776907541e3,
		0.884474885770751758e3,
		0.889797895749890166e3,
		0.895125771918679747e3,
		0.900458490711945116e3,
		0.905796028791646434e3,
		0.911138363043611245e3,
		0.916485470574328714e3,
		0.92183732870780478e3,
		0.927193914982476793e3,
		0.932555207148186218e3,
		0.937921183163208069e3,
		0.943291821191335732e3,
		0.948667099599019897e3,
		0.954046996952560357e3,
		0.959431492015349446e3,
		0.964820563745165946e3,
		0.970214191291518308e3,
		0.975612353993036061e3,
		0.98101503137490834e3,
		0.986422203146368459e3,
		0.991833849198223499e3,
		0.997249949600427919e3,
		0.1002670484599700205e4,
		0.1008095434617181608e4,
		0.1013524780246136048e4,
		0.1018958502249690288e4,
		0.1024396581558613483e4,
		0.1029838999269135277e4,
		0.1035285736640801587e4,
		0.1040736775094367287e4,
		0.1046192096209724989e4,
		0.1051651681723869148e4,
		0.1057115513528894758e4,
		0.1062583573670029889e4,
		0.1068055844343701364e4,
		0.1073532307895632874e4,
		0.1079012946818974866e4,
		0.1084497743752465521e4,
		0.1089986681478622207e4,
		0.1095479742921962756e4,
		0.1100976911147255957e4,
		0.1106478169357800684e4,
		0.1111983500893733047e4,
		0.1117492889230361024e4,
		0.1123006317976526007e4,
		0.1128523770872990714e4,
		0.1134045231790852961e4,
		0.1139570684729984745e4,
		0.1145100113817496168e4,
		0.1150633503306223688e4,
		0.1156170837573242225e4,
	} ;

	if (n < 0)
		return HUGE_VAL;
	else if (n > 254)
	{
		double x = n + 1;
		return (x - 0.5)*log_core(x) - x + 0.5*log_core(2*PI) + 1.0/(12.0*x);
	}
	else
		return lf[n];
}

#if defined(__cplusplus)
}
#endif

#endif /* GML_LOGFACTRIAL_DBL_INTERNAL */
