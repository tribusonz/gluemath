/*******************************************************************************
	GLUE-Math Library: Gaussian Complementary Error Function
	
	Author:
	  Takuya Ooura (Original Algorithm)
	  Hironobu Inatsuka aka tribusonz (C ABI modify)
	License:
	  GPL + X11(MIT)
	Reference:
	  Ooura's Mathematical Software Packages
*******************************************************************************/
#ifndef GML_ERFC_LDBLCMPLX_INTERNAL
#define GML_ERFC_LDBLCMPLX_INTERNAL

#if defined(__cplusplus)
extern "C" {
#endif

#include "../../sys/complex/class.h"
#include "../../sys/complex/arithmetic.h"
#include "../../sys/complex/unary.h"
#include "../../sys/complex/cast.h"
#include "../../sys/float/absolute.h"
#include "cexpl.h"

#if 0
// C99 complex ver.
long double _Complex
cerfcl(long double _Complex x)
{
	static const long double
	pv  = 1.8419880743036792792631929248006767493e+01,
	ph  = 9.4599403715183963963159646240033837464e+00,
	p0  = 2.1093083061644187538279122968913808152e-01,
	p1  = 1.6713797949733065528971052035163045322e-01,
	p2  = 1.0494102880451803704489103456267864462e-01,
	p3  = 5.2209624806229062497556308453704817574e-02,
	p4  = 2.0582158194044619069754225289969978299e-02,
	p5  = 6.4293391618431334949721030322694803569e-03,
	p6  = 1.5913908100149480106505036886507485785e-03,
	p7  = 3.1212060500464898607481297780989148689e-04,
	p8  = 4.8506855193831619356742051276480109919e-05,
	p9  = 5.9733626677651815061875193953000538326e-06,
	p10 = 5.8286735523223186734841193923199386322e-07,
	p11 = 4.5066690471880700341073630648957059945e-08,
	p12 = 2.7610653454261808871589140980422088532e-09,
	p13 = 1.3403949680961254958324655659147790094e-10,
	p14 = 5.1561314110869289752886735305964573946e-12,
	p15 = 1.5716297853674992841622413214543994197e-13,
	p16 = 3.7958724379391814374198930599398267061e-15,
	p17 = 7.2645388829894728683842661597496303959e-17,
	p18 = 1.1016397065175311063529497475707242525e-18,
	p19 = 1.3237506731591609005566634525737840832e-20,
	p20 = 1.2603985415835627864680027724651354389e-22,
	p21 = 9.5092151781247278003169665785149729821e-25,
	p22 = 5.6848177046496801634666761604409403206e-27,
	p23 = 2.6929202705338711046737832028758053393e-29,
	p24 = 1.0108006977320702265677957534508423789e-31,
	p25 = 3.0063715680065086923565072577882673057e-34,
	p26 = 7.0852448481490904907112832127691803349e-37,
	q0  = 2.9088820866572159615394846141476878557e-02,
	q1  = 2.6179938779914943653855361527329190702e-01,
	q2  = 7.2722052166430399038487115353692196393e-01,
	q3  = 1.4253522224620358211543474609323670493e+00,
	q4  = 2.3561944901923449288469825374596271631e+00,
	q5  = 3.5197473248552313134627763831187023054e+00,
	q6  = 4.9160107264506949750017289979095924762e+00,
	q7  = 6.5449846949787359134638403818322976754e+00,
	q8  = 8.4066692304393541288491105348868179031e+00,
	q9  = 1.0501064332832549621157539457073153159e+01,
	q10 = 1.2828170002158322390389127148391303444e+01,
	q11 = 1.5387986238416672436543873608841268757e+01,
	q12 = 1.8180513041607599759621778838423049098e+01,
	q13 = 2.1205750411731104359622842837136644468e+01,
	q14 = 2.4463698348787186236547065604982054867e+01,
	q15 = 2.7954356852775845390394447141959280294e+01,
	q16 = 3.1677725923697081821164987448068320749e+01,
	q17 = 3.5633805561550895528858686523309176233e+01,
	q18 = 3.9822595766337286513475544367681846745e+01,
	q19 = 4.4244096538056254775015560981186332286e+01,
	q20 = 4.8898307876707800313478736363822632855e+01,
	q21 = 5.3785229782291923128865070515590748453e+01,
	q22 = 5.8904862254808623221174563436490679079e+01,
	q23 = 6.4257205294257900590407215126522424733e+01,
	q24 = 6.9842258900639755236563025585685985416e+01,
	q25 = 7.5660023073954187159641994813981361128e+01,
	q26 = 8.1710497814201196359644122811408551868e+01,
	r0  = 1.0857833597842664924141880507518822324e-01,
	r1  = 1.9330394605384376865851659517702988226e-01,
	r2  = 1.3634629684679999083131393208557974008e-01,
	r3  = 7.6204577450604403788088248675471849578e-02,
	r4  = 3.3748451951221171387030636574487677141e-02,
	r5  = 1.1843000251292400843913857684704052043e-02,
	r6  = 3.2930983812757205929921213829383580821e-03,
	r7  = 7.2557574646222760967368809292892366817e-04,
	r8  = 1.2667645289367856821531300675005701424e-04,
	r9  = 1.7524438664090954799894562703988992670e-05,
	r10 = 1.9210002539217758384351411001702958461e-06,
	r11 = 1.6685753127194156512431242433234203465e-07,
	r12 = 1.1484161468186100454021914187739990566e-08,
	r13 = 6.2630784459909945721312231747915945961e-10,
	r14 = 2.7065216004464856039123247342635784082e-11,
	r15 = 9.2676629018209927646524369276088075961e-13,
	r16 = 2.5145718215575387941885792873856026053e-14,
	r17 = 5.4062104214337911880413049229210178595e-16,
	r18 = 9.2099427616964263777001122276945386232e-18,
	r19 = 1.2432429403206980797482152563988923532e-19,
	r20 = 1.3298117235769445146920469835700830835e-21,
	r21 = 1.1270920794418483512403852639398106151e-23,
	r22 = 7.5694395178532891627960685040600391752e-26,
	r23 = 4.0281268032076992671072314251173518774e-28,
	r24 = 1.6985472346741765564942981815307583270e-30,
	r25 = 5.6752788970027027984246568768226680280e-33,
	r26 = 1.5025601745064174185565587049015131885e-35,
	s1  = 1.1635528346628863846157938456590751423e-01,
	s2  = 4.6542113386515455384631753826363005692e-01,
	s3  = 1.0471975511965977461542144610931676281e+00,
	s4  = 1.8616845354606182153852701530545202277e+00,
	s5  = 2.9088820866572159615394846141476878557e+00,
	s6  = 4.1887902047863909846168578443726705123e+00,
	s7  = 5.7014088898481432846173898437294681972e+00,
	s8  = 7.4467381418424728615410806122180809107e+00,
	s9  = 9.4247779607693797153879301498385086526e+00,
	s10 = 1.1635528346628863846157938456590751423e+01,
	s11 = 1.4078989299420925253851105532474809222e+01,
	s12 = 1.6755160819145563938467431377490682049e+01,
	s13 = 1.9664042905802779900006915991638369905e+01,
	s14 = 2.2805635559392573138469559374917872789e+01,
	s15 = 2.6179938779914943653855361527329190702e+01,
	s16 = 2.9786952567369891446164322448872323643e+01,
	s17 = 3.3626676921757416515396442139547271612e+01,
	s18 = 3.7699111843077518861551720599354034610e+01,
	s19 = 4.2004257331330198484630157828292612637e+01,
	s20 = 4.6542113386515455384631753826363005692e+01,
	s21 = 5.1312680008633289561556508593565213775e+01,
	s22 = 5.6315957197683701015404422129899236887e+01,
	s23 = 6.1551944953666689746175494435365075027e+01,
	s24 = 6.7020643276582255753869725509962728196e+01,
	s25 = 7.2722052166430399038487115353692196393e+01,
	s26 = 7.8656171623211119600027663966553479619e+01;

	long double _Complex y = x * x;
	if (fabsl(creall(x)) + fabsl(cimagl(x)) < ph)
	{
		const long double _Complex z = cexpl(pv * x);
		if (creall(z) >= 0)
			y = cexpl(-y) * x *
			   (p26 / (y + q26) +  p25 / (y + q25) +
			    p24 / (y + q24) +  p23 / (y + q23) +
			    p22 / (y + q22) +  p21 / (y + q21) +
			    p20 / (y + q20) +  p19 / (y + q19) +
			    p18 / (y + q18) +  p17 / (y + q17) +
			    p16 / (y + q16) +  p15 / (y + q15) +
			    p14 / (y + q14) +  p13 / (y + q13) +
			    p12 / (y + q12) +  p11 / (y + q11) +
			    p10 / (y + q10) +  p9  / (y + q9)  +
			    p8  / (y + q8)  +  p7  / (y + q7)  +
			    p6  / (y + q6)  +  p5  / (y + q5)  +
			    p4  / (y + q4)  +  p3  / (y + q3)  +
			    p2  / (y + q2)  +  p1  / (y + q1)  +
			    p0  / (y + q0)) +  2 / (1 + z);
		else
			y = cexpl(-y) * x *
			   (r26 / (y + s26) +  r25 / (y + s25) +
			    r24 / (y + s24) +  r23 / (y + s23) +
			    r22 / (y + s22) +  r21 / (y + s21) +
			    r20 / (y + s20) +  r19 / (y + s19) +
			    r18 / (y + s18) +  r17 / (y + s17) +
			    r16 / (y + s16) +  r15 / (y + s15) +
			    r14 / (y + s14) +  r13 / (y + s13) +
			    r12 / (y + s12) +  r11 / (y + s11) +
			    r10 / (y + s10) +  r9  / (y + s9)  +
			    r8  / (y + s8)  +  r7  / (y + s7)  +
			    r6  / (y + s6)  +  r5  / (y + s5)  +
			    r4  / (y + s4)  +  r3  / (y + s3)  +
			    r2  / (y + s2)  +  r1  / (y + s1)  +
			    r0  / y) + 2 / (1 - z);
	}
	else
	{
		y = cexpl(-y) * x *
		   (p26 / (y + q26) +  p25 / (y + q25) +
		    p24 / (y + q24) +  p23 / (y + q23) +
		    p22 / (y + q22) +  p21 / (y + q21) +
		    p20 / (y + q20) +  p19 / (y + q19) +
		    p18 / (y + q18) +  p17 / (y + q17) +
		    p16 / (y + q16) +  p15 / (y + q15) +
		    p14 / (y + q14) +  p13 / (y + q13) +
		    p12 / (y + q12) +  p11 / (y + q11) +
		    p10 / (y + q10) +  p9  / (y + q9)  +
		    p8  / (y + q8)  +  p7  / (y + q7)  +
		    p6  / (y + q6)  +  p5  / (y + q5)  +
		    p4  / (y + q4)  +  p3  / (y + q3)  +
		    p2  / (y + q2)  +  p1  / (y + q1)  +
		    p0  / (y + q0));
		if (creall(x) < 0)  y = y + 2;
	}
	return y;
}
#endif

static inline lcomplex
lc_divadd(long double t1, lcomplex z, long double t2)
{
	z.real += t2;
	return lc_div(ldtolc(t1), z);
}

static inline lcomplex
cerfcl_core(lcomplex x)
{
	static const long double
	pv  = 1.8419880743036792792631929248006767493e+01,
	ph  = 9.4599403715183963963159646240033837464e+00,
	p0  = 2.1093083061644187538279122968913808152e-01,
	p1  = 1.6713797949733065528971052035163045322e-01,
	p2  = 1.0494102880451803704489103456267864462e-01,
	p3  = 5.2209624806229062497556308453704817574e-02,
	p4  = 2.0582158194044619069754225289969978299e-02,
	p5  = 6.4293391618431334949721030322694803569e-03,
	p6  = 1.5913908100149480106505036886507485785e-03,
	p7  = 3.1212060500464898607481297780989148689e-04,
	p8  = 4.8506855193831619356742051276480109919e-05,
	p9  = 5.9733626677651815061875193953000538326e-06,
	p10 = 5.8286735523223186734841193923199386322e-07,
	p11 = 4.5066690471880700341073630648957059945e-08,
	p12 = 2.7610653454261808871589140980422088532e-09,
	p13 = 1.3403949680961254958324655659147790094e-10,
	p14 = 5.1561314110869289752886735305964573946e-12,
	p15 = 1.5716297853674992841622413214543994197e-13,
	p16 = 3.7958724379391814374198930599398267061e-15,
	p17 = 7.2645388829894728683842661597496303959e-17,
	p18 = 1.1016397065175311063529497475707242525e-18,
	p19 = 1.3237506731591609005566634525737840832e-20,
	p20 = 1.2603985415835627864680027724651354389e-22,
	p21 = 9.5092151781247278003169665785149729821e-25,
	p22 = 5.6848177046496801634666761604409403206e-27,
	p23 = 2.6929202705338711046737832028758053393e-29,
	p24 = 1.0108006977320702265677957534508423789e-31,
	p25 = 3.0063715680065086923565072577882673057e-34,
	p26 = 7.0852448481490904907112832127691803349e-37,
	q0  = 2.9088820866572159615394846141476878557e-02,
	q1  = 2.6179938779914943653855361527329190702e-01,
	q2  = 7.2722052166430399038487115353692196393e-01,
	q3  = 1.4253522224620358211543474609323670493e+00,
	q4  = 2.3561944901923449288469825374596271631e+00,
	q5  = 3.5197473248552313134627763831187023054e+00,
	q6  = 4.9160107264506949750017289979095924762e+00,
	q7  = 6.5449846949787359134638403818322976754e+00,
	q8  = 8.4066692304393541288491105348868179031e+00,
	q9  = 1.0501064332832549621157539457073153159e+01,
	q10 = 1.2828170002158322390389127148391303444e+01,
	q11 = 1.5387986238416672436543873608841268757e+01,
	q12 = 1.8180513041607599759621778838423049098e+01,
	q13 = 2.1205750411731104359622842837136644468e+01,
	q14 = 2.4463698348787186236547065604982054867e+01,
	q15 = 2.7954356852775845390394447141959280294e+01,
	q16 = 3.1677725923697081821164987448068320749e+01,
	q17 = 3.5633805561550895528858686523309176233e+01,
	q18 = 3.9822595766337286513475544367681846745e+01,
	q19 = 4.4244096538056254775015560981186332286e+01,
	q20 = 4.8898307876707800313478736363822632855e+01,
	q21 = 5.3785229782291923128865070515590748453e+01,
	q22 = 5.8904862254808623221174563436490679079e+01,
	q23 = 6.4257205294257900590407215126522424733e+01,
	q24 = 6.9842258900639755236563025585685985416e+01,
	q25 = 7.5660023073954187159641994813981361128e+01,
	q26 = 8.1710497814201196359644122811408551868e+01,
	r0  = 1.0857833597842664924141880507518822324e-01,
	r1  = 1.9330394605384376865851659517702988226e-01,
	r2  = 1.3634629684679999083131393208557974008e-01,
	r3  = 7.6204577450604403788088248675471849578e-02,
	r4  = 3.3748451951221171387030636574487677141e-02,
	r5  = 1.1843000251292400843913857684704052043e-02,
	r6  = 3.2930983812757205929921213829383580821e-03,
	r7  = 7.2557574646222760967368809292892366817e-04,
	r8  = 1.2667645289367856821531300675005701424e-04,
	r9  = 1.7524438664090954799894562703988992670e-05,
	r10 = 1.9210002539217758384351411001702958461e-06,
	r11 = 1.6685753127194156512431242433234203465e-07,
	r12 = 1.1484161468186100454021914187739990566e-08,
	r13 = 6.2630784459909945721312231747915945961e-10,
	r14 = 2.7065216004464856039123247342635784082e-11,
	r15 = 9.2676629018209927646524369276088075961e-13,
	r16 = 2.5145718215575387941885792873856026053e-14,
	r17 = 5.4062104214337911880413049229210178595e-16,
	r18 = 9.2099427616964263777001122276945386232e-18,
	r19 = 1.2432429403206980797482152563988923532e-19,
	r20 = 1.3298117235769445146920469835700830835e-21,
	r21 = 1.1270920794418483512403852639398106151e-23,
	r22 = 7.5694395178532891627960685040600391752e-26,
	r23 = 4.0281268032076992671072314251173518774e-28,
	r24 = 1.6985472346741765564942981815307583270e-30,
	r25 = 5.6752788970027027984246568768226680280e-33,
	r26 = 1.5025601745064174185565587049015131885e-35,
	s1  = 1.1635528346628863846157938456590751423e-01,
	s2  = 4.6542113386515455384631753826363005692e-01,
	s3  = 1.0471975511965977461542144610931676281e+00,
	s4  = 1.8616845354606182153852701530545202277e+00,
	s5  = 2.9088820866572159615394846141476878557e+00,
	s6  = 4.1887902047863909846168578443726705123e+00,
	s7  = 5.7014088898481432846173898437294681972e+00,
	s8  = 7.4467381418424728615410806122180809107e+00,
	s9  = 9.4247779607693797153879301498385086526e+00,
	s10 = 1.1635528346628863846157938456590751423e+01,
	s11 = 1.4078989299420925253851105532474809222e+01,
	s12 = 1.6755160819145563938467431377490682049e+01,
	s13 = 1.9664042905802779900006915991638369905e+01,
	s14 = 2.2805635559392573138469559374917872789e+01,
	s15 = 2.6179938779914943653855361527329190702e+01,
	s16 = 2.9786952567369891446164322448872323643e+01,
	s17 = 3.3626676921757416515396442139547271612e+01,
	s18 = 3.7699111843077518861551720599354034610e+01,
	s19 = 4.2004257331330198484630157828292612637e+01,
	s20 = 4.6542113386515455384631753826363005692e+01,
	s21 = 5.1312680008633289561556508593565213775e+01,
	s22 = 5.6315957197683701015404422129899236887e+01,
	s23 = 6.1551944953666689746175494435365075027e+01,
	s24 = 6.7020643276582255753869725509962728196e+01,
	s25 = 7.2722052166430399038487115353692196393e+01,
	s26 = 7.8656171623211119600027663966553479619e+01;

	lcomplex y = lc_mul(x, x);
	if (fabsl(x.real) + fabsl(x.imag) < ph)
	{
		lcomplex z = cexpl_core(lc_mul(ldtolc(pv), x));
		if (z.real >= 0)
			y =
			lc_add(lc_mul(cexpl_core(lc_uminus(y)), lc_mul(x, (
			lc_add(lc_add(lc_add(lc_add(lc_add(lc_add(lc_add(
			lc_add(lc_add(lc_add(lc_add(lc_add(lc_add(
			lc_add(lc_add(lc_add(lc_add(lc_add(lc_add(lc_add(
			lc_add(lc_add(lc_add(lc_add(lc_add(lc_add(
			lc_divadd(p26, y, q26),   lc_divadd(p25, y, q25)),
			lc_divadd(p24, y, q24)),  lc_divadd(p23, y, q23)),
			lc_divadd(p22, y, q22)),  lc_divadd(p21, y, q21)),
			lc_divadd(p20, y, q20)),  lc_divadd(p19, y, q19)),
			lc_divadd(p18, y, q18)),  lc_divadd(p17, y, q17)),
			lc_divadd(p16, y, q16)),  lc_divadd(p15, y, q15)),
			lc_divadd(p14, y, q14)),  lc_divadd(p13, y, q13)),
			lc_divadd(p12, y, q12)),  lc_divadd(p11, y, q11)),
			lc_divadd(p10, y, q10)),  lc_divadd(p9,  y, q9)),
			lc_divadd(p8,  y, q8)),   lc_divadd(p7,  y, q7)),
			lc_divadd(p6,  y, q6)),   lc_divadd(p5,  y, q5)),
			lc_divadd(p4,  y, q4)),   lc_divadd(p3,  y, q3)),
			lc_divadd(p2,  y, q2)),   lc_divadd(p1,  y, q1)),
			lc_divadd(p0,  y, q0))))),
			lc_div(ldtolc(2), lc_add(ldtolc(1), z)));
		else
			y =
			lc_add(lc_mul(cexpl_core(lc_uminus(y)), lc_mul(x, (
			lc_add(lc_add(lc_add(lc_add(lc_add(lc_add(lc_add(
			lc_add(lc_add(lc_add(lc_add(lc_add(lc_add(
			lc_add(lc_add(lc_add(lc_add(lc_add(lc_add(lc_add(
			lc_add(lc_add(lc_add(lc_add(lc_add(lc_add(
			lc_divadd(r26, y, s26),  lc_divadd(r25, y, s25)),
			lc_divadd(r24, y, s24)), lc_divadd(r23, y, s23)),
			lc_divadd(r22, y, s22)), lc_divadd(r21, y, s21)),
			lc_divadd(r20, y, s20)), lc_divadd(r19, y, s19)),
			lc_divadd(r18, y, s18)), lc_divadd(r17, y, s17)),
			lc_divadd(r16, y, s16)), lc_divadd(r15, y, s15)),
			lc_divadd(r14, y, s14)), lc_divadd(r13, y, s13)),
			lc_divadd(r12, y, s12)), lc_divadd(r11, y, s11)),
			lc_divadd(r10, y, s10)), lc_divadd(r9,  y, s9)),
			lc_divadd(r8,  y, s8)),  lc_divadd(r7,  y, s7)),
			lc_divadd(r6,  y, s6)),  lc_divadd(r5,  y, s5)),
			lc_divadd(r4,  y, s4)),  lc_divadd(r3,  y, s3)),
			lc_divadd(r2,  y, s2)),  lc_divadd(r1,  y, s1)),
			lc_div(ldtolc(r0), y))))),
			lc_div(ldtolc(2), lc_sub(ldtolc(1), z)));
	}
	else
	{
		y =
		lc_mul(cexpl_core(lc_uminus(y)), lc_mul(x, (
		lc_add(lc_add(lc_add(lc_add(lc_add(lc_add(lc_add(
		lc_add(lc_add(lc_add(lc_add(lc_add(lc_add(
		lc_add(lc_add(lc_add(lc_add(lc_add(lc_add(lc_add(
		lc_add(lc_add(lc_add(lc_add(lc_add(lc_add(
		lc_divadd(p26, y, q26),  lc_divadd(p25, y, q25)),
		lc_divadd(p24, y, q24)), lc_divadd(p23, y, q23)),
		lc_divadd(p22, y, q22)), lc_divadd(p21, y, q21)),
		lc_divadd(p20, y, q20)), lc_divadd(p19, y, q19)),
		lc_divadd(p18, y, q18)), lc_divadd(p17, y, q17)),
		lc_divadd(p16, y, q16)), lc_divadd(p15, y, q15)),
		lc_divadd(p14, y, q14)), lc_divadd(p13, y, q13)),
		lc_divadd(p12, y, q12)), lc_divadd(p11, y, q11)),
		lc_divadd(p10, y, q10)), lc_divadd(p9,  y, q9)),
		lc_divadd(p8,  y, q8)),  lc_divadd(p7,  y, q7)),
		lc_divadd(p6,  y, q6)),  lc_divadd(p5,  y, q5)),
		lc_divadd(p4,  y, q4)),  lc_divadd(p3,  y, q3)),
		lc_divadd(p2,  y, q2)),  lc_divadd(p1,  y, q1)),
		lc_divadd(p0,  y, q0)))));
		if (x.real < 0)  y = lc_add(y, ldtolc(2));
	}
	return y;
}

#if defined(__cplusplus)
}
#endif

#endif /* GML_ERFC_LDBLCMPLX_INTERNAL */
